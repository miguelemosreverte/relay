name: Deploy and Benchmark

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
    
    - name: Test SSH
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i ~/.ssh/id_ed25519 \
            root@95.217.238.72 "echo 'SSH works'"
    
    - name: Run deployment script
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i ~/.ssh/id_ed25519 \
            root@95.217.238.72 "/root/deploy.sh"
    
    - name: Verify deployment
      run: |
        sleep 5
        curl -s https://95.217.238.72.nip.io/health | grep healthy
    
    - name: Setup Node for benchmarks
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install benchmark dependencies
      run: npm install ws --no-save
    
    - name: Run benchmark
      run: |
        echo "📊 Running WebSocket performance benchmark..."
        
        # Create real WebSocket benchmark script
        cat > benchmark-live.js << 'EOF'
        const WebSocket = require('ws');
        const fs = require('fs');
        
        async function runBenchmark() {
            console.log('🚀 Running benchmark against https://95.217.238.72.nip.io');
            
            const results = {
                timestamp: new Date().toISOString(),
                commit: process.env.GITHUB_SHA || 'unknown',
                metrics: {
                    messages_per_second: 0,
                    bandwidth_mbps: 0,
                    total_messages: 0,
                    total_bytes: 0,
                    latency_ms: 0,
                    connected_users: 2
                }
            };
            
            const startTime = Date.now();
            let messagesSent = 0;
            let messagesReceived = 0;
            let bytesTransferred = 0;
            let latencies = [];
            
            try {
                // Create two WebSocket connections
                const ws1 = new WebSocket('wss://95.217.238.72.nip.io/ws/bench1');
                const ws2 = new WebSocket('wss://95.217.238.72.nip.io/ws/bench2');
                
                await new Promise((resolve, reject) => {
                    let ws1Open = false;
                    let ws2Open = false;
                    
                    ws1.on('open', () => {
                        console.log('Client 1 connected');
                        ws1Open = true;
                        if (ws2Open) startTest();
                    });
                    
                    ws2.on('open', () => {
                        console.log('Client 2 connected');
                        ws2Open = true;
                        if (ws1Open) startTest();
                    });
                    
                    ws1.on('error', reject);
                    ws2.on('error', reject);
                    
                    function startTest() {
                        // Send messages for 10 seconds
                        const interval = setInterval(() => {
                            if (Date.now() - startTime > 10000) {
                                clearInterval(interval);
                                
                                // Calculate results
                                const duration = (Date.now() - startTime) / 1000;
                                results.metrics.messages_per_second = messagesReceived / duration;
                                results.metrics.total_messages = messagesReceived;
                                results.metrics.total_bytes = bytesTransferred;
                                results.metrics.bandwidth_mbps = (bytesTransferred * 8) / (duration * 1000000);
                                if (latencies.length > 0) {
                                    results.metrics.latency_ms = latencies.reduce((a, b) => a + b, 0) / latencies.length;
                                }
                                
                                ws1.close();
                                ws2.close();
                                resolve();
                                return;
                            }
                            
                            const sendTime = Date.now();
                            const msg = JSON.stringify({
                                id: messagesSent++,
                                timestamp: sendTime,
                                data: 'x'.repeat(1000)
                            });
                            ws1.send(msg);
                            bytesTransferred += msg.length;
                        }, 10);
                    }
                    
                    ws2.on('message', (data) => {
                        messagesReceived++;
                        try {
                            const msg = JSON.parse(data);
                            if (msg.timestamp) {
                                latencies.push(Date.now() - msg.timestamp);
                            }
                        } catch {}
                    });
                });
                
            } catch (error) {
                console.error('Benchmark error:', error.message);
                results.error = error.message;
            }
            
            console.log('✅ Benchmark complete!');
            console.log('  Throughput:', results.metrics.messages_per_second.toFixed(2), 'msg/s');
            console.log('  Bandwidth:', results.metrics.bandwidth_mbps.toFixed(2), 'Mbps');
            console.log('  Latency:', results.metrics.latency_ms.toFixed(2), 'ms');
            
            // Save results
            fs.writeFileSync('benchmark-results.json', JSON.stringify(results, null, 2));
        }
        
        runBenchmark().catch(console.error);
        EOF
        
        # Run the benchmark
        GITHUB_SHA=${{ github.sha }} node benchmark-live.js
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-${{ github.sha }}
        path: benchmark-results.json
    
    - name: Prepare GitHub Pages content
      run: |
        echo "📄 Preparing GitHub Pages content..."
        
        mkdir -p gh-pages/reports/${{ github.sha }}
        
        # Copy benchmark results
        cp benchmark-results.json gh-pages/reports/${{ github.sha }}/
        
        # Create or update index.json
        if [ ! -f gh-pages/reports/index.json ]; then
          echo '{"reports":[]}' > gh-pages/reports/index.json
        fi
        
        # Add new report to index using Python
        python3 << EOF
        import json
        import os
        
        # Load benchmark results
        with open('benchmark-results.json', 'r') as f:
            results = json.load(f)
        
        # Create index path if needed
        os.makedirs('gh-pages/reports', exist_ok=True)
        
        # Load or create index
        index_path = 'gh-pages/reports/index.json'
        if os.path.exists(index_path):
            with open(index_path, 'r') as f:
                index = json.load(f)
        else:
            index = {"reports": []}
        
        # Add new entry
        new_entry = {
            "commit": "${{ github.sha }}",
            "timestamp": results['timestamp'],
            "actor": "${{ github.actor }}",
            "branch": "${{ github.ref_name }}",
            "throughput": results['metrics']['messages_per_second'],
            "latency": results['metrics']['latency_ms'],
            "bandwidth": results['metrics']['bandwidth_mbps'],
            "totalMessages": results['metrics']['total_messages'],
            "totalBytes": results['metrics']['total_bytes']
        }
        
        # Add to beginning and keep last 50
        index['reports'].insert(0, new_entry)
        index['reports'] = index['reports'][:50]
        
        # Save updated index
        with open(index_path, 'w') as f:
            json.dump(index, f, indent=2)
        
        print(f"✅ Added benchmark for commit ${{ github.sha }}")
        print(f"   Total reports: {len(index['reports'])}")
        EOF
        
        # Copy dashboard files if they exist
        if [ -d docs ]; then
          cp -r docs/* gh-pages/ 2>/dev/null || true
        fi
        
        echo "✅ GitHub Pages content prepared"
        
        # Debug: Show what we're about to deploy
        echo "📁 Contents of gh-pages directory:"
        ls -la gh-pages/
        echo "📊 Contents of reports directory:"
        ls -la gh-pages/reports/
        echo "📄 Contents of index.json:"
        cat gh-pages/reports/index.json | head -20
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages
        keep_files: true
        commit_message: "📊 Update benchmark for ${{ github.sha }}"